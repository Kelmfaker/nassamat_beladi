<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- add -->
  <title>Nassamat Beladi</title>
  <!-- use public static path -->
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <% if (user && user.role === 'admin') { %>
    <%- include("partials/admin-header") %>
  <% } else { %>
    <%- include("partials/header") %>
  <% } %>

  <!-- Add message div for notifications -->
  <div id="message" style="display: none; position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 15px; border-radius: 5px; z-index: 1000;"></div>

  <div id="content">
    <!-- المحتوى الرئيسي للصفحات سيتم عرضه هنا -->
     
    <section class="main" id="main">
        <div class="main-image"></div>

        <div class="main-content">
          <h2>مرحبا بكم في متجر<br><span>نسمات بلادي</span></h2>
          <h2>لبيع أجود أنواع  المواد الطبيعية</h2>

          <a href="#store" class="main-btn">تسوق الآن</a>

          <div class="social-icon">
            تواصل معنا عبر
            <a href="https://www.instagram.com/nassamat_beladi/"><i class="fa-brands fa-instagram"></i></a>
            <a href="https://www.facebook.com/profile.php?id=61567279060085"><i class="fa-brands fa-facebook-f"></i></a>
            <a href="https://wa.me/c/212616901305"><i class="fa-brands fa-whatsapp"></i></a>
          </div>
        </div>
    </section>

    <section class="content">
     <!--
      <div class="promo-banner">
        <div class="promo-container">
          <p>
            تجدون في متجرنا <span>Thinker Honey</span> عروض وتخفيضات حصرية <strong>على كل منتجات العسل المتوفرة</strong>
          </p>
        </div>
      </div>
-->
      
      <div class="products" id="store">
        <div id="productModal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <p id="modal-text"></p>
          </div>
        </div>

        <% if (typeof products !== 'undefined' && products && products.length > 0) { %>
          <% products.forEach((product, index) => { %>
            <div class="product">
              <div class="prd-img">
                <% if (product && product.image) { %>
                  <img src="/images/<%= product.image %>" width="100" alt="صورة المنتج">
                <% } else { %>
                  <img src="/images/default-product.jpg" width="100" alt="لا توجد صورة">
                <% } %>
              </div>
              
              <div class="prd-description">
                <strong class="prd-title">
                  <span><%= product.name %></span>
                  <div class="prices">
                    <% if (product.originalPrice && product.originalPrice > product.price) { %>
                      <span class="old-price"><%= product.originalPrice %>Dh</span>
                    <% } %>
                    <span class="new-price"><%= product.price %>Dh</span>
                  </div>
                </strong>
                
                <div class="more-des">
                  <p class="description"><%= product.description || 'لا يوجد وصف متاح' %></p>
                  <% if (product.description && product.description.length > 50) { %>
                    <a href="#" class="more" data-description="<%= product.description %>">المزيد</a>
                  <% } %>
                </div>
              </div>

              <div class="center-button">
                <button class="qty-btn" type="button" onclick="changeQuantity(this, -1)">➖</button>
                Kg <span class="quantity">1</span>
                <button class="qty-btn" type="button" onclick="changeQuantity(this, 1)">➕</button>
                
                <button class="add-to-cart"
                  data-id="<%= product._id %>"
                  data-name="<%= product.name %>"
                  data-price="<%= product.price %>"
                  data-image="<%= product.image || 'default-product.jpg' %>"
                  data-max="<%= product.stock || 20 %>">
                  إضافة إلى السلة
                </button>      
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="no-products">
            <h3>لا توجد منتجات متاحة حالياً</h3>
            <p>يرجى المحاولة مرة أخرى لاحقاً</p>
          </div>
        <% } %>
      </div>
    </section>

    <%- include('partials/footer') %>
  </div>

<script>
// إذا تم إرسال الطلب مسبقًا عبر واتساب
window.addEventListener("DOMContentLoaded", () => {
  const orderSent = localStorage.getItem("orderSent");
  if (orderSent === "true") {
    localStorage.removeItem("lastOrder");
    localStorage.removeItem("orderSent");
  }
  updateCartCount(); // تحديث عدد العناصر في السلة عند تحميل الصفحة
});

function changeQuantity(button, delta) {
  const productDiv = button.closest('.product');
  const quantitySpan = productDiv.querySelector('.quantity');
  let qty = parseInt(quantitySpan.textContent);

  const addToCartBtn = productDiv.querySelector('.add-to-cart');
  const max = parseInt(addToCartBtn.dataset.max) || 20;

  qty += delta;
  if (qty < 1) qty = 1;
  if (qty > max) qty = max;

  quantitySpan.textContent = qty;
}

function showMessage(text) {
  const messageDiv = document.getElementById('message');
  if (messageDiv) {
    messageDiv.textContent = text;
    messageDiv.style.display = 'block';

    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 3000);
  }
}

// إضافة المنتجات إلى السلة
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.add-to-cart').forEach(button => {
    button.addEventListener('click', () => {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];

      const id = button.dataset.id;
      const name = button.dataset.name;
      const price = parseFloat(button.dataset.price);
      const image = button.dataset.image;
      const max = parseInt(button.dataset.max);

      const productDiv = button.closest('.product');
      const quantityElement = productDiv.querySelector('.quantity');
      const quantity = parseInt(quantityElement ? quantityElement.textContent : 1);

      const existingProduct = cart.find(p => p.id === id);

      if (existingProduct) {
        if (existingProduct.quantity + quantity <= max) {
          existingProduct.quantity += quantity;
        } else {
          alert('لقد وصلت إلى الحد الأقصى لهذا المنتج');
          return;
        }
      } else {
        if (quantity <= max) {
          cart.push({ id, name, price, image, quantity, max });
        } else {
          alert('الكمية المطلوبة تتجاوز الحد الأقصى المتاح');
          return;
        }
      }

      localStorage.setItem('cart', JSON.stringify(cart));
      showMessage(`تمت إضافة ${quantity} من "${name}" إلى السلة`);
      updateCartCount();
    });
  });
});

function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  let totalItems = 0;
  cart.forEach(item => {
    totalItems += item.quantity;
  });
  
  const cartCountElement = document.getElementById('cart-count');
  if (cartCountElement) {
    cartCountElement.textContent = totalItems;
  }
}

// التحكم في القائمة المتنقلة
const toggleButton = document.getElementById("menu-toggle");
const menu = document.getElementById("nav-links");

if (toggleButton && menu) {
  toggleButton.addEventListener("click", function (e) {
    e.stopPropagation();
    menu.classList.toggle("show");
  });

  // إغلاق القائمة عند الضغط خارجها
  document.addEventListener("click", function (event) {
    if (!menu.contains(event.target) && !toggleButton.contains(event.target)) {
      menu.classList.remove("show");
    }
  });

  // إغلاق عند الضغط على أحد الروابط داخل القائمة
  const links = menu.querySelectorAll("a");
  links.forEach(link => {
    link.addEventListener("click", () => {
      menu.classList.remove("show");
    });
  });

  // إغلاق القائمة عند تمرير الصفحة
  window.addEventListener("scroll", () => {
    menu.classList.remove("show");
  });
}

// تشغيل النافذة المنبثقة عند الضغط على "المزيد"
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.more').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const text = this.getAttribute('data-description');
      const modalText = document.getElementById('modal-text');
      const modal = document.getElementById('productModal');
      
      if (modalText && modal) {
        modalText.innerText = text;
        modal.style.display = 'block';
      }
    });
  });
});

// إغلاق النافذة المنبثقة
function closeModal() {
  const modal = document.getElementById('productModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// إغلاق بالضغط خارج المحتوى
window.onclick = function(e) {
  const modal = document.getElementById('productModal');
  if (modal && e.target == modal) {
    closeModal();
  }
}

// Redirect functions
function redirectToSignup() {
  window.location.href = "/auth/signup";
}

function redirectToLogin() {
  window.location.href = "/auth/login";
}
</script>

  <script src="/js/main.js"></script>
</body>
</html>