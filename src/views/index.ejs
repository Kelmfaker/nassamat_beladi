<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>نسمات بلادي - الرئيسية</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <% if (user && user.role === 'admin') { %>
    <%- include("partials/admin-header") %>
  <% } else { %>
    <%- include("partials/header") %>
  <% } %>

  <main class="home-content">
    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-content">

      

        <h1>مرحباً بكم في نسمات بلادي</h1>
        <p>اكتشف أفضل المنتجات التقليدية المغربية</p>
        <a href="#products" class="btn btn-primary">تصفح المنتجات</a>
      </div>
    </section>

    <!-- Products Section -->
    <section id="products" class="products-section">
      <div class="container">
        <h2>منتجاتنا</h2>
        
        <% if (products && products.length > 0) { %>
          <div class="products-grid">
            <% products.forEach(product => { %>
              <div class="product-card">
                <div class="product-image">
                  <% if (product.image) { const base = (product.image.startsWith('/') ? product.image : ('/images/' + product.image)).replace(/\.(jpg|jpeg|png|webp)$/i, ''); const imgSrc = product.image.startsWith('/') ? product.image : ('/images/' + product.image); %>
                    <img src="<%= imgSrc %>" alt="<%= product.name %>" srcset="<%= base %>-sm.jpg 400w, <%= base %>-md.jpg 800w, <%= base %>-lg.jpg 1200w" sizes="(max-width:480px) 90vw, 360px">
                  <% } else { %>
                    <img src="/images/default-product.jpg" alt="<%= product.name %>">
                  <% } %>
                  <% if (product.stock && product.stock < 5) { %>
                    <span class="badge-stock">بقي <%= product.stock %> فقط</span>
                  <% } %>
                </div>
                <div class="product-info">
                  <h3><%= product.name %></h3>
                  <% if (product.category) { %>
                    <p class="product-category"><%= product.category.name %></p>
                  <% } %>
                  <% if (product.description) { %>
                    <p class="product-description"><%= product.description %></p>
                  <% } %>
                  <div class="product-footer">
                    <p class="product-price"><%= product.price.toFixed(2) %> دج</p>
                    <button 
                      class="btn btn-cart"
                      data-product-id="<%= product._id %>"
                      data-name="<%= (product.name || '').replace(/"/g,'&quot;') %>"
                      data-price="<%= product.price %>"
                      data-image="<%= product.image || '/images/default-product.jpg' %>"
                      data-category="<%= product.category ? (product.category.name || '') : '' %>"
                      onclick="addToCart(this.dataset.productId, this.dataset.name, Number(this.dataset.price), this.dataset.image, this.dataset.category)"
                      <% if (!product.stock || product.stock === 0) { %>disabled<% } %>
                    >
                      <i class="fas fa-shopping-cart"></i>
                      <% if (!product.stock || product.stock === 0) { %>
                        غير متوفر
                      <% } else { %>
                        أضف للسلة
                      <% } %>
                    </button>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <p>لا توجد منتجات متاحة حالياً</p>
          </div>
        <% } %>
      </div>
    </section>

    <!-- Toast notification -->
    <div id="toast" class="toast">
      <i class="fas fa-check-circle"></i>
      <span id="toast-message"></span>
    </div>
  </main>

  <%- include("partials/footer") %>

  <script>
    // Cart management
    function addToCart(productId, name, price, image, category) {
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      
      const existing = cart.find(item => item.productId === productId);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({ 
          productId, 
          name, 
          price, 
          image: image || '/images/default-product.jpg',
          category,
          quantity: 1 
        });
      }
      
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
      showToast('تم إضافة المنتج إلى السلة ✓');
    }

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const total = cart.reduce((sum, item) => sum + item.quantity, 0);
      const el = document.getElementById('cart-count');
      if (el) el.textContent = total;
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toast-message');
      toastMsg.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Initialize cart count on page load
    document.addEventListener('DOMContentLoaded', updateCartCount);
  </script>
</body>
</html>