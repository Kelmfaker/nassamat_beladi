<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= product.name %> - نسمات بلادي</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <%- include("partials/header") %>

  <section class="products-content">
    <div class="products-container">
      <div class="products-header">
        <h1><i class="fas fa-seedling"></i> <%= product.name %></h1>
        <p><%= product.category?.name || '' %></p>
      </div>

      <div class="product-detail-grid">
      <!-- Left: large main image -->
      <div>
        <div class="product-main-image">
          <% if (product.image) { const imgSrc = product.image.startsWith('/') ? product.image : ('/images/' + product.image); %>
            <img id="mainProductImage" src="<%= imgSrc %>" alt="<%= product.name %>">
          <% } else { %>
            <img id="mainProductImage" src="/images/default-product.svg" alt="<%= product.name %>">
          <% } %>
        </div>
      </div>

      <!-- Middle: extra gallery / info (keeps layout balanced) -->
      <div class="product-gallery">
        <% if (product.images && product.images.length) { %>
          <% product.images.forEach(img => { const src = img.startsWith('/') ? img : ('/images/' + img); %>
            <div class="product-thumb"><img src="<%= src %>" loading="lazy" onclick="document.getElementById('mainProductImage').src=this.src"></div>
          <% }) %>
        <% } else { %>
          <!-- fallback: show same image as thumb -->
          <div class="product-thumb"><img src="<%= product.image ? (product.image.startsWith('/') ? product.image : ('/images/' + product.image)) : '/images/default-product.svg' %>" loading="lazy"></div>
        <% } %>
      </div>

      <!-- Right: actions, title, description -->
      <aside>
        <!-- Product detail as a form: quantity + add to cart (handled by existing localStorage addToCart) -->
        <form id="productForm" class="product-side-actions product-side" onsubmit="handleProductFormSubmit(event)">
          <input type="hidden" name="productId" value="<%= product._id %>">

          <div style="display:flex;flex-direction:column;gap:.5rem">
            <div style="display:flex;gap:.5rem;align-items:center">
              <label for="productQty" style="font-weight:700;margin-right:.5rem">الكمية</label>
              <input id="productQty" name="quantity" type="number" min="1" value="1" style="width:80px;padding:.5rem;border-radius:6px;border:1px solid #e0e0e0;text-align:center;">
            </div>

            <button type="submit" class="btn btn-primary"><i class="fas fa-cart-plus icon" aria-hidden="true"></i> أضف للسلة</button>
            <a href="#reviews" class="btn btn-secondary"><i class="fas fa-star icon" aria-hidden="true"></i> مراجعات</a>
          </div>

          <div>
            <h1 class="product-title"><%= product.name %></h1>
            <div class="category"><%= product.category?.name || 'بدون قسم' %></div>
            <div class="price"><%= Number(product.price).toFixed(2) %> <%= currencySymbol %></div>
          </div>

          <div>
            <p class="prd-desc"><%= product.description || '-' %></p>
            <button type="button" class="read-more" aria-expanded="false">اقرأ المزيد</button>
          </div>

          <div class="side-image-box">
            <% if (product.image) { const imgSrc2 = product.image.startsWith('/') ? product.image : ('/images/' + product.image); %>
              <img src="<%= imgSrc2 %>" alt="<%= product.name %>">
            <% } %>
          </div>
        </form>
      </aside>
    </div>

    <!-- Related products -->
    <% if (relatedProducts && relatedProducts.length) { %>
      <section style="margin-top:2rem">
        <h3>منتجات مشابهة</h3>
        <div class="products-grid" style="margin-top:1rem">
          <% relatedProducts.forEach(p => { const img = p.image ? (p.image.startsWith('/') ? p.image : ('/images/' + p.image)) : '/images/default-product.svg'; %>
            <div class="product">
              <div class="prd-img"><img src="<%= img %>" alt="<%= p.name %>"></div>
              <div class="prd-description">
                <div class="prd-title"><%= p.name %></div>
                <div class="prices"><div class="new-price"><%= Number(p.price).toFixed(2) %> <%= currencySymbol %></div></div>
                <a class="more" href="/products/<%= p._id %>">تفاصيل</a>
              </div>
            </div>
          <% }) %>
        </div>
      </section>
    <% } %>

    </div>
  </section>

  <%- include("partials/footer") %>

  <script>
    // Form submit handler for product detail form
    function handleProductFormSubmit(e) {
      e.preventDefault();
      try {
        const qtyEl = document.getElementById('productQty');
        const qty = qtyEl ? parseInt(qtyEl.value, 10) || 1 : 1;
        const pid = '<%= product._id %>';
        addToCart(pid, qty);
      } catch (err) {
        console.error('Failed to add product from form', err);
      }
    }

    // Add to cart (local storage) - same behaviour used elsewhere
    function addToCart(productId, quantity) {
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const existing = cart.find(item => item.productId === productId);
      if (existing) {
        existing.quantity += quantity;
      } else {
        // build values safely as JS strings/numbers
        const _name = "<%= (product.name || '').replace(/\"/g, '\\\"') %>";
  const _price = "<%= Number(product.price || 0) %>";
        const _image = "<%= (product.image || '/images/default-product.svg').replace(/\"/g, '\\\"') %>";
        cart.push({ productId, name: _name, price: _price, image: _image, quantity });
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      alert('تمت إضافة المنتج إلى السلة');
    }

    // Read-more toggle
    document.addEventListener('DOMContentLoaded', () => {
      const p = document.querySelector('.prd-desc');
      const btn = document.querySelector('.read-more');
      if (!p || !btn) return;
      if (p.scrollHeight <= p.clientHeight + 2) btn.style.display = 'none';
      btn.addEventListener('click', () => {
        const expanded = p.classList.toggle('expanded');
        btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        btn.textContent = expanded ? 'عرض أقل' : 'اقرأ المزيد';
      });
    });
  </script>
</body>
</html>
