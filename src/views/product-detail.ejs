<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= product.name %> - نسمات بلادي</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <%- include("partials/header") %>

  <main class="content admin-dashboard" style="padding:2rem;">
    <div class="admin-container">
      <div class="products-container">
      <div class="products-header">
        <h1><i class="fas fa-seedling"></i> <%= product.name %></h1>
        <p><%= product.category?.name || '' %></p>
      </div>

      <!-- Main image (full width above the details) -->
      <div class="product-main-wrap">
        <div class="product-main-image small">
          <% if (product.image) { const imgSrc = product.image.startsWith('/') ? product.image : ('/images/' + product.image); %>
            <img id="mainProductImage" src="<%= imgSrc %>" alt="<%= product.name %>" width="72" height="72" style="object-fit:cover;border-radius:6px;" />
          <% } else { %>
            <img id="mainProductImage" src="/images/default-product.svg" alt="<%= product.name %>" width="72" height="72" style="object-fit:contain;border-radius:6px;background:#fff;padding:6px;" />
          <% } %>
        </div>
      </div>

      <div class="product-detail-grid">
      <!-- Gallery removed: thumbnails hidden to simplify product detail -->

      <!-- Right: actions, title, description -->
      <aside>
        <div class="admin-card">
          <h2>معلومات المنتج</h2>
          <!-- Use admin-form styling so product info looks like the admin user form -->
          <form id="productForm" class="admin-form" onsubmit="handleProductFormSubmit(event)">
            <input type="hidden" name="productId" value="<%= product._id %>">

            <div class="form-row">
              <div class="form-group">
                <label>الاسم</label>
                <div class="text-field"><%= (product.name || '') %></div>
              </div>
              <div class="form-group">
                <label>القسم</label>
                <div class="text-field"><%= (product.category?.name || 'بدون قسم') %></div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>السعر (لكل وحدة)</label>
                <div class="text-field"><%= Number(product.price).toFixed(2) %> <%= currencySymbol %></div>
              </div>
              <div class="form-group">
                <label for="productQty">الكمية</label>
                <input id="productQty" name="quantity" type="number" min="1" value="1">
              </div>
            </div>

            <div class="form-group">
              <label>الوصف</label>
              <div class="text-field description"><%= product.description || '-' %></div>
            </div>

            <div style="display:flex;gap:.5rem;align-items:center">
              <button type="submit" class="btn btn-primary"><i class="fas fa-cart-plus icon" aria-hidden="true"></i> أضف للسلة</button>
              <a href="#reviews" class="btn btn-secondary" style="width:auto;padding:12px 18px;display:inline-flex;align-items:center;"><i class="fas fa-star icon" aria-hidden="true"></i> مراجعات</a>
            </div>

        
          </form>
        </div>
      </aside>
    </div>

    <!-- Related products -->
    <% if (relatedProducts && relatedProducts.length) { %>
      <section style="margin-top:2rem">
        <h3>منتجات مشابهة</h3>
        <div class="products-grid" style="margin-top:1rem">
          <% relatedProducts.forEach(p => { const img = p.image ? (p.image.startsWith('/') ? p.image : ('/images/' + p.image)) : '/images/default-product.svg'; %>
            <div class="product">
              <div class="prd-img"><img src="<%= img %>" alt="<%= p.name %>"></div>
              <div class="prd-description">
                <div class="prd-title"><%= p.name %></div>
                <div class="prices"><div class="new-price"><%= Number(p.price).toFixed(2) %> <%= currencySymbol %></div></div>
                <a class="more" href="/products/<%= p._id %>">تفاصيل</a>
              </div>
            </div>
          <% }) %>
        </div>
      </section>
    <% } %>

    </div>
  </section>

  <%- include("partials/footer") %>

  <script>
    // Form submit handler for product detail form
    function handleProductFormSubmit(e) {
      e.preventDefault();
      try {
        const qtyEl = document.getElementById('productQty');
        const qty = qtyEl ? parseInt(qtyEl.value, 10) || 1 : 1;
        const pid = '<%= product._id %>';
        addToCart(pid, qty);
      } catch (err) {
        console.error('Failed to add product from form', err);
      }
    }

    // Add to cart (local storage) - same behaviour used elsewhere
    function addToCart(productId, quantity) {
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const existing = cart.find(item => item.productId === productId);
      if (existing) {
        existing.quantity += quantity;
      } else {
        // build values safely as JS strings/numbers
        const _name = "<%= (product.name || '').replace(/\"/g, '\\\"') %>";
  const _price = "<%= Number(product.price || 0) %>";
        const _image = "<%= (product.image || '/images/default-product.svg').replace(/\"/g, '\\\"') %>";
        cart.push({ productId, name: _name, price: _price, image: _image, quantity });
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      alert('تمت إضافة المنتج إلى السلة');
    }

    // Read-more toggle
    document.addEventListener('DOMContentLoaded', () => {
      const p = document.querySelector('.prd-desc');
      const btn = document.querySelector('.read-more');
      if (!p || !btn) return;
      if (p.scrollHeight <= p.clientHeight + 2) btn.style.display = 'none';
      btn.addEventListener('click', () => {
        const expanded = p.classList.toggle('expanded');
        btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        btn.textContent = expanded ? 'عرض أقل' : 'اقرأ المزيد';
      });
    });
  </script>
</body>
</html>
